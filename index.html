<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>數字分析工具（v3.1.1 調試版）</title>
  <style>
    :root{--brand:#2463eb;--text:#111827;--muted:#6b7280;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",Arial,sans-serif;color:var(--text)}
    .wrap{max-width:960px;margin:0 auto;padding:16px 16px 72px}
    h1{font-size:28px;margin:8px 0 12px;font-weight:800}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
    input[type=text]{height:42px;padding:0 12px;border:1px solid var(--border);border-radius:8px;font-size:16px;width:220px}
    button{height:42px;padding:0 16px;border:0;border-radius:9px;background:var(--brand);color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#6b7280}
    .muted{color:var(--muted);margin-top:4px}
    .pill{border:2px solid #ef4444;border-radius:8px;padding:10px;display:inline-block;margin:6px 0;font-weight:700;background:#fff}
    .grid3{display:grid;grid-template-columns:1fr;gap:16px;margin-top:10px}
    @media(min-width:900px){.grid3{grid-template-columns:repeat(3,1fr)}}
    table{width:100%;border-collapse:collapse;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#fff}
    th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:right;font-variant-numeric:tabular-nums}
    th:first-child,td:first-child{text-align:left}
    thead th{background:#f8fafc}
    .card-title{font-weight:800;margin:6px 0 8px}
    .section{margin-top:12px}
    .warn{color:#b45309;background:#fff7ed;border:1px solid #fed7aa;padding:8px 12px;border-radius:8px;display:none;margin-top:8px}
    .debug{font-size:12px;color:#065f46;background:#ecfdf5;border:1px solid #a7f3d0;padding:8px 10px;border-radius:8px;margin-top:10px;display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>數字分析工具（6 → 6/5/4 整合）</h1>
    <div class="row">
      <input id="q" type="text" inputmode="numeric" pattern="[0-9]*" maxlength="6" placeholder="輸入 6 碼，例如 321445" />
      <button id="go">查詢</button>
      <button id="clear" class="secondary" type="button">清除</button>
    </div>
    <div class="muted">會讀取 <code>data/result_filtered_data.csv</code> 的「結果 / 開獎結果」欄，統計指定序列在資料中出現後「下一碼」的次數。</div>
    <div id="warn" class="warn"></div>

    <div id="result" style="display:none;">
      <div class="section">
        <div style="font-weight:800;margin-bottom:6px">加總結果摘要</div>
        <div id="top3" class="muted"></div>
        <div class="pill" id="oddEven"></div><br/>
        <div class="pill" id="bigSmall"></div>
      </div>

      <div class="section">
        <div style="font-weight:800;margin-bottom:6px">整合加總對比表</div>
        <div id="agg"></div>
      </div>

      <div class="section">
        <div style="font-weight:800;margin-bottom:6px">三組查詢結果</div>
        <div class="grid3" id="grids"></div>
      </div>

      <div id="debug" class="debug"></div>
    </div>
  </div>

<script>
const CSV_PATH = 'data/result_filtered_data.csv';
const $ = s => document.querySelector(s);
let dataset = [];

async function loadCSV() {
  const res = await fetch(CSV_PATH, {cache:'no-store'});
  if (!res.ok) throw new Error('讀取資料失敗：' + res.status);
  const text = await res.text();
  const rows = text.trim().split(/\\r?\\n/);
  // 去除 BOM
  const rawHeader = rows.shift();
  const header = rawHeader.split(',').map(h => h.replace(/^\\ufeff/, '').trim());
  const idx = header.findIndex(h => ['結果','開獎結果'].includes(h));
  if (idx === -1) throw new Error('CSV 內找不到「結果/開獎結果」欄位（實際欄位：'+header.join(' | ')+')');
  const arr = [];
  for (const r of rows) {
    if (!r.trim()) continue;
    const cols = r.split(',');
    const v = Number.parseInt((cols[idx]||'').trim(),10);
    if (Number.isFinite(v)) arr.push(v);
  }
  return arr;
}

function nextCounts(pattern, data){
  const n = pattern.length;
  const counts = {1:0,2:0,3:0,4:0,5:0,6:0};
  let matches = 0;
  for (let i=0;i+n<data.length;i++){
    let ok = true;
    for (let j=0;j<n;j++){
      if (Number(data[i+j]) !== Number(pattern[j])) { ok=false; break; }
    }
    if (ok){
      const nxt = Number(data[i+n]);
      if (counts[nxt]!=null) counts[nxt]++;
      matches++;
    }
  }
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  return {counts, total, matches};
}

function renderTable(title, stat){
  let rows='';
  for (let d=1; d<=6; d++){
    const c = stat.counts[d]||0;
    const pct = stat.total ? Math.round(c*100/stat.total) : 0;
    rows += `<tr><td>${d}</td><td style="text-align:right">${c}</td><td style="text-align:right">${pct}%</td></tr>`;
  }
  return `<div><div class="card-title">${title}</div>
  <table><thead><tr><th>數字</th><th>次數</th><th>機率</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function aggregate(stats){
  const agg={1:0,2:0,3:0,4:0,5:0,6:0};
  stats.forEach(s=>{ for(let d=1;d<=6;d++) agg[d]+= (s.counts[d]||0); });
  return agg;
}

function renderAgg(agg){
  const total = Object.values(agg).reduce((a,b)=>a+b,0);
  const arr = Object.entries(agg).map(([d,c])=>({d:+d,c:+c})).sort((a,b)=> b.c-a.c || a.d-b.d);
  const rows = arr.map(({d,c})=>{
    const pct = total? Math.round(c*100/total):0;
    return `<tr><td>${d}</td><td style="text-align:right">${c}</td><td style="text-align:right">${pct}%</td></tr>`;
  }).join('');
  return `<table><thead><tr><th>數字</th><th>次數</th><th>機率</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function summary(agg){
  const arr=[]; for(let d=1;d<=6;d++){ arr.push({d, c:agg[d]||0}); }
  arr.sort((a,b)=> b.c-a.c || a.d-b.d);
  const top3 = arr.slice(0,3).map(x=> `${x.d} (${x.c}次)`).join('，');
  const odd=(agg[1]||0)+(agg[3]||0)+(agg[5]||0);
  const even=(agg[2]||0)+(agg[4]||0)+(agg[6]||0);
  const big=(agg[4]||0)+(agg[5]||0)+(agg[6]||0);
  const small=(agg[1]||0)+(agg[2]||0)+(agg[3]||0);
  let oe = `單 ${odd}，雙 ${even} → ` + (odd>even?`單比雙多 ${odd-even} 次`: even>odd?`雙比單多 ${even-odd} 次`:`一樣多`);
  let bs = `大 ${big}，小 ${small} → ` + (big>small?`大比小多 ${big-small} 次`: small>big?`小比大多 ${small-big} 次`:`一樣多`);
  return {top3:`前三名：${top3}`, oe, bs};
}

async function main(){
  try{ dataset = await loadCSV(); }
  catch(e){ $('#warn').style.display='block'; $('#warn').textContent=e.message; }
}
main();

function run(){
  const raw = $('#q').value.trim();
  if (!/^[0-9]{6}$/.test(raw)){
    $('#warn').style.display='block';
    $('#warn').textContent='請輸入 6 碼數字（例如 321445）';
    return;
  }
  $('#warn').style.display='none';

  const p6 = raw, p5 = raw.slice(1), p4 = raw.slice(2);
  const patterns = [
    {label:`${p6}`, arr: p6.split('').map(n=>+n)},
    {label:`${p5}`, arr: p5.split('').map(n=>+n)},
    {label:`${p4}`, arr: p4.split('').map(n=>+n)},
  ];

  const stats = patterns.map(p => ({ title:`${p.label} 查詢結果`, stat: nextCounts(p.arr, dataset) }));

  const agg = aggregate(stats.map(s=>s.stat));
  const s = summary(agg);

  // Render
  $('#result').style.display='block';
  $('#top3').innerHTML = s.top3;
  $('#oddEven').textContent = s.oe;
  $('#bigSmall').textContent = s.bs;
  $('#agg').innerHTML = renderAgg(agg);
  $('#grids').innerHTML = stats.map(x=>renderTable(x.title, x.stat)).join('');

  // Debug info
  const dbg = [`資料筆數：${dataset.length}`].concat(stats.map(x => `${x.title.replace(' 查詢結果','')} 出現：${x.stat.total} 次（可統計下一碼的總數）`));
  const hasAny = Object.values(agg).some(v => v>0);
  const dbgBox = document.getElementById('debug');
  dbgBox.style.display='block';
  dbgBox.textContent = dbg.join('； ');
  if (!hasAny){
    dbgBox.textContent += '；整合為 0，可能原因：1) 這三組序列在資料中都沒有出現；2) 上線的 CSV 不是你本機那份；3) 欄位名或編碼（BOM）導致解析失敗。';
  }
}

document.getElementById('go').addEventListener('click', run);
document.getElementById('clear').addEventListener('click', ()=>{
  document.getElementById('q').value='';
  document.getElementById('result').style.display='none';
  document.getElementById('warn').style.display='none';
  const dbg = document.getElementById('debug'); dbg.style.display='none'; dbg.textContent='';
  document.getElementById('q').focus();
});
document.getElementById('q').addEventListener('keydown', (e)=>{ if(e.key==='Enter') run(); });
</script>
</body>
</html>
