<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>數字分析工具</title>
  <style>
    :root{
      --fg:#111;--muted:#6b7280;--border:#e5e7eb;--bg:#ffffff;--accent:#2563eb;
    }
    body{font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,"Noto Sans TC","PingFang TC",system-ui,Helvetica,Arial,sans-serif;
      margin:0;background:var(--bg);color:var(--fg);}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px;}
    h1{font-size:28px;margin:8px 0 20px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="tel"]{
      font-size:18px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;outline:none;width:280px;
    }
    input[type="tel"]:focus{border-color:#cbd5e1;box-shadow:0 0 0 3px #e5efff}
    button{
      border:1px solid var(--border);background:#f8fafc;border-radius:20px;padding:8px 16px;
      font-size:16px;cursor:pointer;
    }
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted)}
    .section{margin-top:18px}
    .summary{font-size:16px;line-height:1.8}
    .pill{display:inline-block;background:#f3f4f6;border:1px solid var(--border);padding:2px 8px;border-radius:999px;margin-right:6px}
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin-top:12px}
    .card{grid-column:span 12;border:1px solid var(--border);border-radius:8px;padding:12px}
    @media(min-width:720px){
      .card.third{grid-column:span 4}
      .card.half{grid-column:span 6}
    }
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border:1px solid var(--border);padding:6px 8px;text-align:center}
    th{background:#f8fafc}
    .hint{margin-top:8px}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .redline{border:2px solid #ef4444;border-radius:6px;padding:10px;margin:10px 0}
    .small{font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>數字分析工具</h1>

    <div class="row">
      <input id="seq" type="tel" inputmode="numeric" pattern="[0-9]*" maxlength="6"
             placeholder="輸入六碼，例如123456" aria-label="輸入六碼">
      <button id="search" class="primary" disabled>查詢</button>
      <button id="clear">清除</button>
      <span id="status" class="muted small"></span>
    </div>

    <div id="output" class="section" style="display:none">
      <div class="card">
        <div class="summary" id="sumHeader"></div>

        <div class="redline" id="oddEvenLine"></div>
        <div class="redline" id="bigSmallLine"></div>

        <div class="section">
          <h3 style="margin:0 0 8px">二組加總對比表</h3>
          <div id="aggTable"></div>
        </div>
      </div>

      <div class="cards" id="detailCards"></div>
    </div>

    <div class="hint muted small">
      資料來源：同目錄的 <span class="pill">result_filtered_data_fixed.csv</span>（需包含欄位「結果」）。<br>
      使用方式：輸入 6 碼，按「查詢」。會同時查 <span class="pill">6碼</span>、<span class="pill">5碼</span>、<span class="pill">4碼</span> 並加總。
    </div>
  </div>

<script>
(() => {
  const CSV_PATH = 'result_filtered_data_fixed.csv'; // 與 index.html 放一起
  const $ = sel => document.querySelector(sel);

  const els = {
    seq: $('#seq'),
    search: $('#search'),
    clear: $('#clear'),
    status: $('#status'),
    output: $('#output'),
    sumHeader: $('#sumHeader'),
    oddEvenLine: $('#oddEvenLine'),
    bigSmallLine: $('#bigSmallLine'),
    aggTable: $('#aggTable'),
    detailCards: $('#detailCards'),
  };

  let dataArr = [];   // [1,2,3, ...]
  let ready = false;

  // 讀檔 + 解析
  async function loadCSV() {
    els.status.textContent = '載入資料…';
    try {
      const res = await fetch(CSV_PATH, {cache: 'no-store'});
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();

      // 解析 CSV：找欄位「結果」
      const lines = text.replace(/\r/g,'').split('\n').filter(x=>x.trim().length);
      if (lines.length === 0) throw new Error('空檔案');
      const header = lines[0].replace(/^\uFEFF/,'');
      const cols = header.split(',');
      let idx = cols.findIndex(c => c.trim().replace(/"/g,'') === '結果');
      if (idx < 0) idx = 0; // 找不到就用第一欄

      dataArr = [];
      for (let i=1;i<lines.length;i++){
        const cells = splitCSVLine(lines[i]);
        const v = (cells[idx] ?? '').toString().trim().replace(/"/g,'');
        if (/^[1-6]$/.test(v)) dataArr.push(Number(v));
      }
      if (dataArr.length === 0) throw new Error('未解析到數據（結果欄位需為 1~6）');

      ready = true;
      els.status.textContent = `資料載入完成（${dataArr.length} 筆）`;
      maybeToggleSearch();
    } catch (e) {
      console.error(e);
      els.status.textContent = '資料檔案載入失敗，請確認 result_filtered_data_fixed.csv 與欄位名稱「結果」。';
    }
  }

  // 簡易 CSV 逐行分隔（處理引號）
  function splitCSVLine(line){
    const out = []; let cur = ''; let inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"'){
        if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
      }else if(ch===',' && !inQ){
        out.push(cur); cur='';
      }else cur += ch;
    }
    out.push(cur);
    return out;
  }

  // 驗證與 UI 控制
  function sanitizeDigits(v){
    return (v||'').replace(/\D/g,'').slice(0,6);
  }
  function maybeToggleSearch(){
    els.search.disabled = !(ready && els.seq.value.length === 6);
  }

  // 核心分析：找出 pattern 後一碼的分布（1..6）
  function analyzePattern(patternStr){
    const pat = patternStr.split('').map(n=>Number(n));
    const L = pat.length;
    const counts = {1:0,2:0,3:0,4:0,5:0,6:0};
    let total = 0;

    for (let i=0;i+L < dataArr.length;i++){
      let ok = true;
      for (let j=0;j<L;j++){
        if (dataArr[i+j] !== pat[j]) { ok = false; break; }
      }
      if (ok){
        const nxt = dataArr[i+L];
        counts[nxt]++; total++;
      }
    }

    // 單雙 / 大小
    let odd=0, even=0, big=0, small=0;
    for (let d=1; d<=6; d++){
      const c = counts[d];
      if (d%2===0) even+=c; else odd+=c;
      if (d>=4) big+=c; else small+=c;
    }
    return {pattern: patternStr, counts, total, odd, even, big, small};
  }

  function render(){
    const full = els.seq.value;
    const p6 = full;
    const p5 = full.slice(1);
    const p4 = full.slice(2);

    const r6 = analyzePattern(p6);
    const r5 = analyzePattern(p5);
    const r4 = analyzePattern(p4);

    // 加總
    const agg = {counts:{1:0,2:0,3:0,4:0,5:0,6:0}, total:0, odd:0, even:0, big:0, small:0};
    [r6,r5,r4].forEach(r=>{
      agg.total += r.total;
      agg.odd   += r.odd;
      agg.even  += r.even;
      agg.big   += r.big;
      agg.small += r.small;
      for (let d=1; d<=6; d++) agg.counts[d] += r.counts[d];
    });

    // 前三名（依次數）
    const top = Object.entries(agg.counts)
      .map(([d,c])=>({d:Number(d),c}))
      .sort((a,b)=>b.c-a.c)
      .slice(0,3);

    const topTxt = top.map(t=>`${t.d}（${t.c}次）`).join('，');
    els.sumHeader.innerHTML =
      `<div class="summary">
        <div style="margin-bottom:6px" class="muted">前三名：<b>${topTxt||'—'}</b></div>
        <div class="muted small">查詢序列：
          <span class="pill">${r6.pattern}</span>
          <span class="pill">${r5.pattern}</span>
          <span class="pill">${r4.pattern}</span>
        </div>
      </div>`;

    // 單雙 / 大小文案（紅框）
    const oddEvenDiff = Math.abs(agg.even - agg.odd);
    const oddEvenLead = (agg.even >= agg.odd) ? '雙' : '單';
    els.oddEvenLine.innerHTML =
      `單 <b>${agg.odd}</b> ，雙 <b>${agg.even}</b> → <b>${oddEvenLead}</b>比${oddEvenLead==='雙'?'單':'雙'}多 <b>${oddEvenDiff}</b> 次`;

    const bigSmallDiff = Math.abs(agg.big - agg.small);
    const bigSmallLead = (agg.big >= agg.small) ? '大' : '小';
    els.bigSmallLine.innerHTML =
      `大 <b>${agg.big}</b> ，小 <b>${agg.small}</b> → <b>${bigSmallLead}</b>比${bigSmallLead==='大'?'小':'大'}多 <b>${bigSmallDiff}</b> 次`;

    // 二組加總對比表（依總次數排序）
    els.aggTable.innerHTML = buildTable(
      [['數字','次數','機率']].concat(
        Object.entries(agg.counts)
          .map(([d,c])=>({d:Number(d),c, p: agg.total? Math.round(c*100/agg.total):0}))
          .sort((a,b)=>b.c-a.c)
          .map(x=>[x.d, x.c, `${x.p}%`])
      )
    );

    // 個別結果卡片（1~6 正序）
    els.detailCards.innerHTML = '';
    [r6,r5,r4].forEach((r,idx)=>{
      const table = buildTable(
        [['數字','次數','機率']].concat(
          [...Array(6)].map((_,i)=>{
            const d=i+1, c=r.counts[d];
            const p = r.total? Math.round(c*100/r.total):0;
            return [d,c,`${p}%`];
          })
        )
      );
      const card = document.createElement('div');
      card.className = 'card third';
      card.innerHTML = `<h3 style="margin:0 0 8px">${r.pattern} 查詢結果</h3>${table}`;
      els.detailCards.appendChild(card);
    });

    els.output.style.display = 'block';
  }

  function buildTable(rows){
    let html = '<table><thead><tr>';
    rows[0].forEach(h=> html += `<th>${h}</th>`);
    html += '</tr></thead><tbody>';
    for (let i=1;i<rows.length;i++){
      html += '<tr>' + rows[i].map(v=>`<td>${v}</td>`).join('') + '</tr>';
    }
    html += '</tbody></table>';
    return html;
  }

  // 事件
  els.seq.addEventListener('input',()=>{
    els.seq.value = sanitizeDigits(els.seq.value);
    maybeToggleSearch();
  });
  els.search.addEventListener('click',()=>{
    if (els.seq.value.length !== 6) return;
    render();
  });
  els.clear.addEventListener('click',()=>{
    els.seq.value = '';
    els.output.style.display = 'none';
    maybeToggleSearch();
    els.seq.focus();
  });

  // 初始化
  loadCSV();
})();
</script>
</body>
</html>
